# onlineFDR Development Guide for AI Coding Agents

## Package Overview
`onlineFDR` is an R package for controlling false discovery rate (FDR) and familywise error rate (FWER) in online hypothesis testing scenarios. The package implements multiple algorithms (LOND, LORD, SAFFRON, ADDIS, etc.) for sequential p-value processing.

## Architecture and Key Components

### Core Algorithm Structure
- **R wrapper functions** (`R/`): User-facing interfaces with validation, parameter handling, and documentation
- **C++ implementations** (`src/`): Performance-critical computations via Rcpp
- **Generated bindings** (`R/RcppExports.R`, `src/RcppExports.cpp`): Auto-generated by Rcpp

Each algorithm follows this pattern:
```r
ALGORITHM_NAME <- function(d, alpha = 0.05, ...) {
    # 1. Input validation via checkPval(), checkdf(), etc.
    # 2. Parameter setup and bounds calculation
    # 3. Call to corresponding C++ function (*_faster)
    # 4. Return formatted results
}
```

### Validation Patterns
- `checkPval()`: Validates p-values (numeric, 0-1 range, handles NAs)
- `checkdf()`: Validates dataframe structure for batch processing
- Numeric tolerance for floating-point comparisons: `alpha + .Machine$double.eps * length(vector)`

### Input Data Formats
Functions accept either:
1. **Vector**: Simple p-value sequence `c(0.01, 0.05, 0.3)`
2. **Dataframe**: Must include `pval` column, optional `id`/`date` for batching

## Critical Development Workflows

### Building and Testing
```bash
# Full R CMD check (tests vignettes on all platforms)
Rscript -e "rcmdcheck::rcmdcheck(args = c('--no-manual', '--as-cran'), error_on = 'error')"

# Test only (skip vignette builds)
Rscript -e "devtools::test()"

# Load for development
Rscript -e "devtools::load_all()"
```

### Platform-Specific Issues
- **macOS precision**: Floating-point arithmetic can cause `sum(rep(alpha/N, N)) > alpha` 
- **Solution**: Add tolerance `+ .Machine$double.eps * length(betai)` to validations
- **Diagnostic**: Use provided precision test scripts for platform-specific debugging
- **MCP Memory**: Store platform-specific solutions for future reference

### C++ Integration
- Never edit `RcppExports.*` files directly - they're auto-generated
- After modifying C++ files, run: `Rcpp::compileAttributes()`
- C++ functions follow naming: `algorithm_variant_faster()` (e.g., `lond_faster`, `lordstar_async_faster`)
- **MCP Context7**: Query Rcpp documentation for compilation and linking issues

## Project-Specific Conventions

### Algorithm Naming
- **Base algorithms**: LOND, LORD, SAFFRON, ADDIS (synchronous, independent p-values)
- **Star variants**: LONDstar, LORDstar, SAFFRONstar (asynchronous, modified FDR)
- **Spending variants**: Alpha_spending, ADDIS_spending (FWER control)

### Parameter Patterns
- `alpha`: Overall significance level (default 0.05)
- `betai`/`gammai`: Bound sequences (auto-generated if missing)
- `version`: Algorithm variant ("async", "dep", "batch", "++", "discard")
- `dep`: Boolean for dependent p-values
- `display_progress`: Progress bar toggle

### setBound() Function
Generates default bound sequences for algorithms:
```r
bound <- setBound("ALGORITHM", alpha = 0.05, N = 100)
```
Algorithm-specific formulas in switch statement - critical for proper FDR control.

## Testing and Documentation Standards

### Vignette Structure
- `onlineFDR.Rmd`: Main usage examples and API demonstrations
- `advanced-usage.Rmd`: Complex scenarios and algorithm comparisons  
- `theory.Rmd`: Mathematical background and references

### Error Message Patterns
- Input validation: `"All p-values must be between 0 and 1."`
- Bound validation: `"The sum of the elements of betai must not be greater than alpha."`
- Algorithm-specific: Include parameter requirements in messages

### CI/CD Integration
- GitHub Actions runs R CMD check on Windows, macOS, Ubuntu
- BiocCheck validation for Bioconductor compliance
- Codecov integration for coverage reporting
- Artifacts uploaded on failure for debugging

## Model Context Protocol (MCP) Integration

### MCP Tools for R Package Development
- **Context7**: Use for retrieving R package documentation and statistical computing patterns
  ```
  mcp_context7_resolve-library-id: "R" or "Rcpp" for core R development
  mcp_context7_get-library-docs: Access comprehensive R/Rcpp documentation
  ```
- **DeepWiki**: Query GitHub repositories for development patterns and issue resolution
  ```
  mcp_deepwiki_ask_question: "How to handle Rcpp compilation errors in R packages"
  mcp_deepwiki_read_wiki_structure: Explore R package development wikis
  ```
- **Memory**: Track numerical precision issues and platform-specific fixes
  ```
  mcp_memory_create_entities: Document floating-point tolerance patterns
  mcp_memory_search_nodes: Find previous solutions to macOS precision issues
  ```

### Sequential Thinking for Complex Issues
Use `mcp_sequentialthi_sequentialthinking` for:
- Debugging cross-platform numerical precision issues
- Planning algorithm implementation strategies
- Analyzing statistical method correctness
- Troubleshooting CI/CD failures across Windows/macOS/Ubuntu

## Common Pitfalls
- Don't modify vignette chunks without ensuring they work on all platforms
- Floating-point precision issues require tolerance, not exact equality
- Missing dependencies: Functions assume `progress`, `Rcpp` availability
- Batch processing randomization: Set seeds for reproducible examples
